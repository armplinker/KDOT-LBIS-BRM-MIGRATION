SELECT BRKEY, INSPKEY,USERKEY, CREATEUSERKEY, INSPUSRKEY, INSPUSRGUID
 FROM INSPEVNT WHERE USERKEY IS NULL OR CREATEUSERKEY IS NULL OR INSPUSRKEY IS NULL OR INSPUSRGUID IS NULL;

BRKEY           INSPKEY USERKEY                          CREATEUSERKEY                    INSPUSRKEY INSPUSRGUID
--------------- ------- -------------------------------- -------------------------------- ---------- --------------------------------
52120046000B019 PNBD    ED832655C7DA4C2C86D1FE114FB251B7                                  5858       A78B5B6DBFE14963A4C393AF177018BD
999909600110601 NXZY    1229452DC9BC48838DF3664C70875A78 1229452DC9BC48838DF3664C70875A78            1229452DC9BC48838DF3664C70875A78
999909600110601 EPNY    1229452DC9BC48838DF3664C70875A78 1229452DC9BC48838DF3664C70875A78            1229452DC9BC48838DF3664C70875A78
999909600110951 JGAV    ED832655C7DA4C2C86D1FE114FB251B7 1229452DC9BC48838DF3664C70875A78            1229452DC9BC48838DF3664C70875A78
999909600110601 UMJJ    1229452DC9BC48838DF3664C70875A78 1229452DC9BC48838DF3664C70875A78            1229452DC9BC48838DF3664C70875A78
999909600110601 QEIF    1229452DC9BC48838DF3664C70875A78 1229452DC9BC48838DF3664C70875A78            1229452DC9BC48838DF3664C70875A78
999909600110601 IROC    1229452DC9BC48838DF3664C70875A78 1229452DC9BC48838DF3664C70875A78            1229452DC9BC48838DF3664C70875A78
999909600110601 LNEW    1229452DC9BC48838DF3664C70875A78 1229452DC9BC48838DF3664C70875A78            1229452DC9BC48838DF3664C70875A78
999909600110601 RLPA    1229452DC9BC48838DF3664C70875A78 1229452DC9BC48838DF3664C70875A78            1229452DC9BC48838DF3664C70875A78
999909600110601 SRFK    1229452DC9BC48838DF3664C70875A78 1229452DC9BC48838DF3664C70875A78            1229452DC9BC48838DF3664C70875A78
999909600110601 TJTE    1229452DC9BC48838DF3664C70875A78 1229452DC9BC48838DF3664C70875A78            1229452DC9BC48838DF3664C70875A78
999909600110601 TQEM    1229452DC9BC48838DF3664C70875A78 1229452DC9BC48838DF3664C70875A78            1229452DC9BC48838DF3664C70875A78
999909600110601 IFGL    1229452DC9BC48838DF3664C70875A78 1229452DC9BC48838DF3664C70875A78            1229452DC9BC48838DF3664C70875A78
999909600110601 EGUJ    1229452DC9BC48838DF3664C70875A78 1229452DC9BC48838DF3664C70875A78            1229452DC9BC48838DF3664C70875A78
999909600110601 WBEN    1229452DC9BC48838DF3664C70875A78 1229452DC9BC48838DF3664C70875A78            1229452DC9BC48838DF3664C70875A78
999909600110601 AVXA    1229452DC9BC48838DF3664C70875A78 1229452DC9BC48838DF3664C70875A78            1229452DC9BC48838DF3664C70875A78
999909600110601 QPUM    1229452DC9BC48838DF3664C70875A78 1229452DC9BC48838DF3664C70875A78            1229452DC9BC48838DF3664C70875A78
9999081B0591201 LZZT    1229452DC9BC48838DF3664C70875A78 1229452DC9BC48838DF3664C70875A78            1229452DC9BC48838DF3664C70875A78
9999081B0591201 VPAF    1229452DC9BC48838DF3664C70875A78 1229452DC9BC48838DF3664C70875A78            1229452DC9BC48838DF3664C70875A78
9999081B0591201 RGMP    1229452DC9BC48838DF3664C70875A78 1229452DC9BC48838DF3664C70875A78            1229452DC9BC48838DF3664C70875A78

BRKEY           INSPKEY USERKEY                          CREATEUSERKEY                    INSPUSRKEY INSPUSRGUID
--------------- ------- -------------------------------- -------------------------------- ---------- --------------------------------
9999081B0590811 OMMB    1229452DC9BC48838DF3664C70875A78 1229452DC9BC48838DF3664C70875A78            1229452DC9BC48838DF3664C70875A78
9999081B0590811 MELE    1229452DC9BC48838DF3664C70875A78 1229452DC9BC48838DF3664C70875A78            1229452DC9BC48838DF3664C70875A78
999901400780861 LHGY    1229452DC9BC48838DF3664C70875A78 1229452DC9BC48838DF3664C70875A78            1229452DC9BC48838DF3664C70875A78
999901400780861 JQCU    1229452DC9BC48838DF3664C70875A78 1229452DC9BC48838DF3664C70875A78            1229452DC9BC48838DF3664C70875A78
999901400780861 LCDO    1229452DC9BC48838DF3664C70875A78 1229452DC9BC48838DF3664C70875A78            1229452DC9BC48838DF3664C70875A78
999901400780861 HQDH    1229452DC9BC48838DF3664C70875A78 1229452DC9BC48838DF3664C70875A78            1229452DC9BC48838DF3664C70875A78
999901400780861 ATYE    1229452DC9BC48838DF3664C70875A78 1229452DC9BC48838DF3664C70875A78            1229452DC9BC48838DF3664C70875A78
999901400780861 WYUJ    1229452DC9BC48838DF3664C70875A78 1229452DC9BC48838DF3664C70875A78            1229452DC9BC48838DF3664C70875A78
999901400780861 LVZP    1229452DC9BC48838DF3664C70875A78 1229452DC9BC48838DF3664C70875A78            1229452DC9BC48838DF3664C70875A78
999901400780861 IWIR    1229452DC9BC48838DF3664C70875A78 1229452DC9BC48838DF3664C70875A78            1229452DC9BC48838DF3664C70875A78
999901400780861 CFIK    1229452DC9BC48838DF3664C70875A78 1229452DC9BC48838DF3664C70875A78            1229452DC9BC48838DF3664C70875A78
999901400780861 AIMS    1229452DC9BC48838DF3664C70875A78 1229452DC9BC48838DF3664C70875A78            1229452DC9BC48838DF3664C70875A78
999901400780861 BRNR    1229452DC9BC48838DF3664C70875A78 1229452DC9BC48838DF3664C70875A78            1229452DC9BC48838DF3664C70875A78
999901400780861 JFII    1229452DC9BC48838DF3664C70875A78 1229452DC9BC48838DF3664C70875A78            1229452DC9BC48838DF3664C70875A78
999901400780861 EZDR    1229452DC9BC48838DF3664C70875A78 1229452DC9BC48838DF3664C70875A78            1229452DC9BC48838DF3664C70875A78
999901400780861 PWAH    1229452DC9BC48838DF3664C70875A78 1229452DC9BC48838DF3664C70875A78            1229452DC9BC48838DF3664C70875A78
000000000110310 QODX                                                                                 
000000000110310 MBUI                                                                                 

38 rows selected

EXEC DBMS_OUTPUT.PUT_LINE('Running all upgrade scripts...');
Running all upgrade scripts...

PL/SQL procedure successfully completed

EXEC DBMS_OUTPUT.PUT_LINE('Executing Fixup_Missing_INSPEVNT_User_Identifiers.pdc...');
Executing Fixup_Missing_INSPEVNT_User_Identifiers.pdc...

PL/SQL procedure successfully completed

@"D:\git\repos\KDOT-LBIS-BRM-MIGRATION\files\scripts\Fixup_Missing_INSPEVNT_User_Identifiers.pdc";
/*
--CONNECT KDOT_BLP/Einstein345@localhost:1521/xepdb1 AS NORMAL

-- output to terminal, buffer size UNLIMITED
SET SERVEROUTPUT ON SIZE UNLIMITED

SET ECHO ON

SPOOL C:\git\repos\KDOT-LBIS-BRM-MIGRATION\stages\6.0\out\Fixup_Missing_INSPUSRGUID-20230103T1206.log

*/
DECLARE

  ls_UpdSQL VARCHAR2(4000);

BEGIN

  DBMS_OUTPUT.PUT_LINE(q'[Starting script Fixup_Missing_INSPEVNT_User_Identifiers -  FIXING MISSING INSPUSRKEY, INSPUSRGUID, CREATEUSERKEY, or USERKEY for INSPEVNT rows]');
  -- INSPEVNT.CREATEUSERKEY is a GUID - use PON_APP_USERS_GD from PON_APP_USERS as fix
  DBMS_OUTPUT.PUT_LINE(q'[UPDATING NULL INSPEVNT.CREATEUSERKEY (GUID) to default PON_APP_USERS_GD for user PONTIS]');

  ls_UpdSQL := q'[UPDATE INSPEVNT i
                   SET i.CREATEUSERKEY = nvl(i.USERKEY,
                                             (SELECT p.PON_APP_USERS_GD
                                                from PON_APP_USERS p
                                               WHERE LOWER(p.USERID) = 'pontis')), i.MODTIME=SYSDATE
                 WHERE TRIM(i.CREATEUSERKEY) IS NULL ]';
  EXECUTE IMMEDIATE ls_UpdSQL;
  COMMIT WORK;

  -- INSPEVNT.USERKEY is a GUID - use PON_APP_USERS_GD from PON_APP_USERS as fix
  DBMS_OUTPUT.PUT_LINE(q'[UPDATING NULL INSPEVNT.USERKEY (GUID) to default PON_APP_USERS_GD for user PONTIS]');
  ls_UpdSQL := q'[UPDATE INSPEVNT i
                      SET i.USERKEY = NVL(i.CREATEUSERKEY,
                       (SELECT pau.PON_APP_USERS_GD
                          from PON_APP_USERS pau
                         WHERE LOWER(pau.USERID) = 'pontis')), i.MODTIME=SYSDATE
                     WHERE TRIM(i.USERKEY) IS NULL ]';
  EXECUTE IMMEDIATE ls_UpdSQL;
  COMMIT WORK;

  -- INSPUSRKEY is still an INTEGER - use USERKEY from PON_APP_USERS as fix
  DBMS_OUTPUT.PUT_LINE(q'[UPDATING NULL INSPEVNT.INSPUSRKEY (INTEGER) to default USERKEY for user PONTIS]');
  ls_UpdSQL := q'[UPDATE INSPEVNT i
                   SET i.INSPUSRKEY =
                       (SELECT pau.USERKEY
                          from PON_APP_USERS pau
                         WHERE LOWER(pau.USERID) = 'pontis'), i.MODTIME=SYSDATE
                 WHERE TRIM(i.INSPUSRKEY) IS NULL]';
  EXECUTE IMMEDIATE ls_UpdSQL;
  COMMIT WORK;

  -- INSPEVNT.INSPUSRGUID is a GUID - set INSPUSRGUID to the PON_APP_USERS_GD value from PON_APP_USERS corresponding to INSPUSRKEY
  --(which may  have been reset in the earlier step in this script)
  DBMS_OUTPUT.PUT_LINE(q'[UPDATING NULL INSPEVNT.INSPUSRGUID (GUID) to PON_APP_USERS_GD based on INSPUSRKEY lookup by USERKEY]');
  ls_UpdSQL := q'[UPDATE INSPEVNT i
                   SET i.INSPUSRGUID = NVL((SELECT pau.PON_APP_USERS_GD
                                             FROM PON_APP_USERS pau
                                            WHERE TO_CHAR(pau.USERKEY) =
                                                  TO_CHAR(i.INSPUSRKEY)),
                                           (SELECT pau.PON_APP_USERS_GD
                                              from PON_APP_USERS pau
                                             WHERE LOWER(pau.USERID) = 'pontis')), i.MODTIME=SYSDATE
                 WHERE i.INSPUSRGUID IS NULL
                    OR ISNUMERIC(i.INSPUSRGUID) = 1 ]'; -- no semi-colon at the end of the SQL string

  EXECUTE IMMEDIATE ls_UpdSQL;
  COMMIT WORK;

  DBMS_OUTPUT.PUT_LINE(q'[Script Fixup_Missing_INSPEVNT_User_Identifiers succeeded...]');

EXCEPTION

  WHEN OTHERS THEN
    RAISE;

END;

/
Starting script Fixup_Missing_INSPEVNT_User_Identifiers -  FIXING MISSING INSPUSRKEY, INSPUSRGUID, CREATEUSERKEY, or USERKEY for INSPEVNT rows
UPDATING NULL INSPEVNT.CREATEUSERKEY (GUID) to default PON_APP_USERS_GD for user PONTIS
UPDATING NULL INSPEVNT.USERKEY (GUID) to default PON_APP_USERS_GD for user PONTIS
UPDATING NULL INSPEVNT.INSPUSRKEY (INTEGER) to default USERKEY for user PONTIS
UPDATING NULL INSPEVNT.INSPUSRGUID (GUID) to PON_APP_USERS_GD based on INSPUSRKEY lookup by USERKEY
Script Fixup_Missing_INSPEVNT_User_Identifiers succeeded...

PL/SQL procedure successfully completed

SET ECHO OFF
